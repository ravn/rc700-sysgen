# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This repository contains Z80 assembly source code for the RC702 computer system, focusing on:
- **SYSGEN.COM** - Modified CP/M SYSGEN utility for RC702 multi-density 8" floppy support
- **ROA375** - RC702 autoload PROM (boot ROM) source reconstruction

The goal is to recreate byte-exact source code for these RC702-specific components that were missing from Michael Ringgård's RC702 emulator project (http://www.jbox.dk/rc702/).

**See `RC702_HARDWARE_TECHNICAL_REFERENCE.md` for comprehensive hardware documentation including I/O ports, memory maps, disk formats, and controller specifications.**

## Key Components

### sysgen/
Contains the SYSGEN utility files:
- `SYSGEN.ASM` - Main source file (actively edited)
- `RCSYSGEN.COM` - Original RC702 binary (reference target)
- `SYSGEN.COM` - Newly assembled binary (should match RCSYSGEN.COM)
- `SYSGEN.ORG` - Original CP/M 2.2 SYSGEN source (reference)
- `SYSGEN.Z80` - IDA disassembly output (for reference)
- `SYSGEN.SYM` - Symbol file generated by MAC assembler

### roa375/
Contains the RC702 autoload PROM:
- `roa375.rom` - Binary ROM image
- `rob358.mac` - RC703 version source (reference/inspiration)

### autoload-in-c/
C rewrite of the ROA375 autoload PROM using z88dk with sdcc backend:
- `crt0.asm` - Assembly startup, interrupt handlers, HAL functions
- `boot_entry.c` - Self-relocation loop (compiled into BOOT section)
- `boot.c` - Boot logic, directory validation, error handling
- `fdc.c` - FDC driver (seek, read, sense, result handling)
- `fmt.c` - Disk format tables and track geometry
- `isr.c` - Floppy interrupt body
- `init.c` - Hardware initialization (PIO, CTC, DMA, CRT)
- `rom_all.c` - Unity build (includes all C files for cross-function optimization)
- `hal.h` / `boot.h` - Headers
- `hal_host.c` - Mock HAL for host testing
- `test_boot.c` / `test_fdc.c` - Host test suites

#### PROM Image Layout (2048 bytes max)
```
Address   Section  Contents
--------  -------  ----------------------------------------
0x0000    BOOT     Entry point (asm): DI, SP, CALL relocate, JP 0x7000
0x000A             clear_screen (asm, runs from ROM)
0x0018             init_fdc (asm, runs from ROM)
0x0034             display_banner (asm, frees 30 bytes in CODE for C)
...                relocate (C, boot_entry.c --codeseg BOOT)
...                [gap — available for more BOOT C code]
0x0066    NMI      RETN (Z80 hardware NMI vector, fixed address)
0x0068    CODE     Payload start in ROM, copied to RAM at 0x7000:
                     Interrupt handlers, HAL functions (asm)
                     Interrupt vector table at 0x7100 (256-byte aligned)
                     Boot logic, FDC driver, format tables (C)
                     Read-only data: message strings, format tables
```
BOOT and NMI sections are in ROM, accessible until `hal_prom_disable()`.
CODE payload is copied to RAM at 0x7000 by `relocate()` using linker
symbols `__NMI_tail` (source), `__CODE_head`/`__tail` (length).

### rcbios/
CP/M BIOS source reconstruction and tools:
- `src/` - Modular BIOS source (BIOS.MAC, CPMBOOT.MAC, INIT.MAC, SIO.MAC, etc.)
- `verify_bios.py` - Verify assembled BIOS against reference binaries
- `patch_bios.py` - Patch assembled BIOS onto IMD disk images for emulator testing
- `imdinfo.py` - Show disk image summary: format (MINI/MAXI), geometry, boot status
- `imd2raw.py` - Extract raw Track 0 data from IMD disk images
- `bin2imd.py` - Convert raw disk images to IMD format

#### BIOS Variants
Built with conditional assembly flags:
- `make rel21-mini` — rel.2.1, 5.25" mini, 56K (verified)
- `make rel22-mini` — rel.2.2, 5.25" mini, 56K (verified)
- `make rel23-maxi` — rel.2.3, 8" maxi, 56K (verified)
- `make rel14-maxi` — rel.1.4, 8" maxi, 58K (assembles OK, different codebase)
- `make verify` — build all and verify against reference binaries

#### Patching BIOS onto Disk Images
```bash
cd rcbios
make rel22-mini
python3 patch_bios.py image.imd zout/BIOS.cim -o patched.imd   # create copy
python3 patch_bios.py image.imd zout/BIOS.cim                   # patch in place
python3 patch_bios.py image.imd --info                          # show Track 0 layout
```

The tool maps `.cim` bytes sequentially onto Track 0 sectors (sorted by sector number), first Side 0 then Side 1. Supports both MINI and MAXI formats.

`make patch-test` automates the full cycle: build, patch, boot in emulator, verify signon.

### zmac/
Z80 macro assembler toolchain:
- `bin/zmac` - Compiled assembler binary for macOS
- Built from http://48k.ca/zmac.zip

## Building/Assembling

### Using zmac (Host System)
The preferred method uses zmac on macOS/Linux:

```bash
cd sysgen
zmac -z --dri SYSGEN.ASM
```

This generates `zout/SYSGEN.cim` which should be byte-identical to SYSGEN.COM.

To build zmac if needed:
```bash
cd zmac
make
```

### Using MAC (CP/M Emulator)
Alternative method under CP/M emulation (e.g., RunCPM):

```bash
MAC SYSGEN
LOAD SYSGEN
```

See http://www.cpm.z80.de/manuals/mac.pdf for MAC assembler documentation.

## Verification

Check that assembly succeeded with correct alignment:
```bash
grep -q '04EF SIGNON' SYSGEN.SYM && dhex RCSYSGEN.COM SYSGEN.COM
```

The grep ensures byte alignment is correct before comparing binaries with dhex.

## File Format Considerations

Before committing symbol files, remove CP/M ^Z EOF characters so git recognizes them as ASCII:
```bash
perl -i -pe 's/\032//g' SYSGEN.SYM
```

## Assembly Language Context

- **Target Processor**: Z80
- **Assembler Syntax**: Digital Research MAC assembler syntax
- **Directives**: Uses `.Z80`, `ORG`, `EQU`, `DB`, `DW`, etc.
- **Output Format**: CP/M .COM files (org 0100h)

The MAC assembler produces single-character error codes (see README.md section "MAC error codes" for full list). Common errors:
- `L` - Label error (duplicate or invalid placement)
- `U` - Undefined symbol
- `P` - Phase error (label value differs between passes)
- `S` - Syntax error

## Architecture Notes

The RC702 required SYSGEN modifications because it supported multiple floppy densities on 8" disks, unlike standard CP/M 2.2 systems.

### RC702 8" Diskette Layout
The 8" diskette uses a mixed-density format for backward compatibility:
- **Track 0, Side 0**: FM encoding (single density), 26 sectors × 128 bytes
- **Track 0, Side 1**: MFM encoding (double density), 26 sectors × 256 bytes
- **Tracks 1-76, both sides**: MFM encoding (double density), 15 sectors × 512 bytes

Total capacity: ~1.2MB (DS/DD format)

### RC702 5.25" Diskette Layout
The 5.25" diskette also uses multi-density:
- **Track 0, Side 0**: FM encoding, 16 sectors × 128 bytes (2KB)
- **Track 0, Side 1**: MFM encoding, 16 sectors × 256 bytes (4KB)
- **Tracks 1-34, both sides**: MFM encoding, 9 sectors × 512 bytes with 2:1 interleave

Total capacity: ~319KB

### Multi-Density Implementation
This multi-density format required extensive SYSGEN modifications:
- Dynamic density switching during track read/write operations
- Custom disk format parameters (`rc_diskformat`, `spt`, `rctrk1fmt1`, `rctrk1fmt2`)
- Track skewing tables (`maxitrans`, `minitrans`) for 2:1 sector interleave
- Sector mapping logic for Track 1's three density zones
- RC702-specific BIOS calls for format detection

### Hardware Controllers
- **CPU**: Z80-A at 4 MHz
- **FDC**: NEC µPD765 (or Intel 8272) floppy disk controller
- **DMA**: AMD Am9517A-4 (or Intel 8237-2) for disk transfers
- **CRT**: Intel 8275 programmable CRT controller
- **Display**: 80×24 characters at memory address 0x7800

### Boot Process
The autoload PROM (ROA375) bootstraps the system:
1. Self-relocate from ROM (0x0000) to RAM (0x7000)
2. Initialize interrupt vectors at 0x7300 (Z80 Mode 2)
3. Initialize PIO, DMA, CTC, and CRT controllers
4. Attempt hard disk boot, fallback to floppy
5. Read Track 0 (mixed density) to 0x0000
6. Disable ROM via port 0x14
7. Jump to 0x0000 (CP/M cold boot)
