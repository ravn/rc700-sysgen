# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This repository contains Z80 assembly source code for the RC702 computer system, focusing on:
- **SYSGEN.COM** - Modified CP/M SYSGEN utility for RC702 multi-density 8" floppy support
- **ROA375** - RC702 autoload PROM (boot ROM) source reconstruction

The goal is to recreate byte-exact source code for these RC702-specific components that were missing from Michael Ringg√•rd's RC702 emulator project (http://www.jbox.dk/rc702/).

## Key Components

### sysgen/
Contains the SYSGEN utility files:
- `SYSGEN.ASM` - Main source file (actively edited)
- `RCSYSGEN.COM` - Original RC702 binary (reference target)
- `SYSGEN.COM` - Newly assembled binary (should match RCSYSGEN.COM)
- `SYSGEN.ORG` - Original CP/M 2.2 SYSGEN source (reference)
- `SYSGEN.Z80` - IDA disassembly output (for reference)
- `SYSGEN.SYM` - Symbol file generated by MAC assembler

### roa375/
Contains the RC702 autoload PROM:
- `roa375.rom` - Binary ROM image
- `rob358.mac` - RC703 version source (reference/inspiration)

### zmac/
Z80 macro assembler toolchain:
- `bin/zmac` - Compiled assembler binary for macOS
- Built from http://48k.ca/zmac.zip

## Building/Assembling

### Using zmac (Host System)
The preferred method uses zmac on macOS/Linux:

```bash
cd sysgen
zmac -8 --dri SYSGEN.ASM
```

This generates `zout/SYSGEN.cim` which should be byte-identical to SYSGEN.COM.

To build zmac if needed:
```bash
cd zmac
make
```

### Using MAC (CP/M Emulator)
Alternative method under CP/M emulation (e.g., RunCPM):

```bash
MAC SYSGEN
LOAD SYSGEN
```

See http://www.cpm.z80.de/manuals/mac.pdf for MAC assembler documentation.

## Verification

Check that assembly succeeded with correct alignment:
```bash
grep -q '04EF SIGNON' SYSGEN.SYM && dhex RCSYSGEN.COM SYSGEN.COM
```

The grep ensures byte alignment is correct before comparing binaries with dhex.

## File Format Considerations

Before committing symbol files, remove CP/M ^Z EOF characters so git recognizes them as ASCII:
```bash
perl -i -pe 's/\032//g' SYSGEN.SYM
```

## Assembly Language Context

- **Target Processor**: Z80
- **Assembler Syntax**: Digital Research MAC assembler syntax
- **Directives**: Uses `.Z80`, `ORG`, `EQU`, `DB`, `DW`, etc.
- **Output Format**: CP/M .COM files (org 0100h)

The MAC assembler produces single-character error codes (see README.md section "MAC error codes" for full list). Common errors:
- `L` - Label error (duplicate or invalid placement)
- `U` - Undefined symbol
- `P` - Phase error (label value differs between passes)
- `S` - Syntax error

## Architecture Notes

The RC702 required SYSGEN modifications because it supported multiple floppy densities on 8" disks, unlike standard CP/M 2.2 systems. The modifications involve:
- Custom disk format parameters (`rc_diskformat`, `spt`)
- Track skewing tables (`maxitrans`)
- RC702-specific initialization

The autoload PROM (ROA375) bootstraps the system by loading the first sectors from disk or line program interface into memory at 0A000h and jumping to it.
